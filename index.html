<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè• Broken Handoff AI - Clinical Safety Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #10b981 100%);
            min-height: 100vh; padding: 20px; color: #1f2937;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 40px; animation: glow 2s ease-in-out infinite alternate; }
        @keyframes glow { from { text-shadow: 0 0 20px #60a5fa; } to { text-shadow: 0 0 30px #34d399; } }
        
        .card { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); border-radius: 24px; padding: 35px; margin-bottom: 25px; box-shadow: 0 25px 50px rgba(0,0,0,0.15); border: 1px solid rgba(255,255,255,0.2); transition: all 0.3s ease; }
        
        .nav-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .back-home-btn { background: #1e293b; color: white; border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: 0.3s; }
        .back-home-btn:hover { background: #334155; transform: scale(1.05); }

        .btn { background: linear-gradient(45deg, #10b981, #34d399); color: white; border: none; padding: 16px 32px; border-radius: 16px; font-size: 1.1rem; font-weight: 700; cursor: pointer; width: 100%; margin-bottom: 20px; transition: all 0.3s; box-shadow: 0 10px 30px rgba(16,185,129,0.3); }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 20px 40px rgba(16,185,129,0.4); }
        .btn-primary { background: linear-gradient(45deg, #3b82f6, #60a5fa); }
        .btn-secondary { background: #64748b; }

        .section { display: none; animation: slideIn 0.5s ease-out; }
        .section.active { display: block; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 700; margin-bottom: 8px; color: #1e293b; }
        input, textarea, select { width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; }

        .tab-nav { display: flex; flex-wrap: wrap; gap: 5px; background: #f1f5f9; padding: 5px; border-radius: 16px; margin-bottom: 20px; }
        .tab-btn { flex: 1; min-width: 120px; padding: 12px; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; transition: 0.3s; }
        .tab-btn.active { background: #3b82f6; color: white; }

        .tab-content { display: none; padding: 20px; border: 1px solid #e2e8f0; border-radius: 16px; background: white; }
        .tab-content.active { display: block; }

        .risk-circle { width: 180px; height: 180px; border-radius: 50%; margin: 0 auto 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 800; border: 8px solid #eee; }
        .risk-high { background: #fee2e2; color: #dc2626; border-color: #dc2626; }
        .risk-moderate { background: #fef3c7; color: #d97706; border-color: #d97706; }
        .risk-low { background: #dcfce7; color: #16a34a; border-color: #16a34a; }

        .checkbox-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
        .check-box { background: #fff; border: 2px solid #e2e8f0; padding: 15px; border-radius: 12px; display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 12px; background: #f8fafc; border-bottom: 2px solid #e2e8f0; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; }

        .pdf-scanner { background: #fef3c7; border: 2px dashed #f59e0b; padding: 15px; border-radius: 16px; margin-bottom: 20px; text-align: center; }
        .keyword-badge { background: #ef4444; color: white; padding: 4px 10px; border-radius: 8px; font-size: 0.8rem; margin: 2px; display: inline-block; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üè• Broken Handoff AI</h1>
        <p>Production-Grade Clinical Dashboard</p>
    </div>

    <div id="home" class="card section active">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
            <div style="background:white; padding:20px; border-radius:16px; text-align:center;">
                <h2 id="s-high" style="color:#ef4444">0</h2><p>High Risk</p>
            </div>
            <div style="background:white; padding:20px; border-radius:16px; text-align:center;">
                <h2 id="s-total">0</h2><p>Total Cases</p>
            </div>
        </div>
        <button class="btn" onclick="showSection('outgoing')">üì§ Create Outgoing Case</button>
        <button class="btn btn-primary" onclick="showSection('dashboard')">üìã Hospital Dashboard</button>
        <button class="btn btn-secondary" onclick="showSection('incoming')">üì• Incoming Nurse Verification</button>
    </div>

    <div id="outgoing" class="card section">
        <div class="nav-header">
            <h2>üì§ New Handoff Entry</h2>
            <button class="back-home-btn" onclick="showSection('home')">üè† Back Home</button>
        </div>
        
        <div class="form-grid">
            <div class="form-group"><label>Patient Name</label><input type="text" id="p-name"></div>
            <div class="form-group"><label>Age</label><input type="number" id="p-age"></div>
            <div class="form-group"><label>Ward Location</label><input type="text" id="p-ward"></div>
        </div>

        <div class="pdf-scanner">
            <label>üìÑ Upload Clinical Chart / PDF (Optional AI Scan)</label>
            <input type="file" id="pdf-upload" accept=".pdf,.txt" style="margin-top:10px;">
            <p style="font-size: 0.8rem; margin-top: 5px;">AI will scan for: DNR, Sepsis, Stop, Discontinue, Ventilator.</p>
        </div>

        <div class="form-group">
            <label>Handoff Notes (Nurse 1)</label>
            <textarea id="p-notes" rows="4" placeholder="Mention critical updates..."></textarea>
        </div>
        <button class="btn" onclick="saveNewCase()">üíæ Initialize Case</button>
    </div>

    <div id="dashboard" class="card section">
        <div class="nav-header">
            <h2>üìã Patient Records</h2>
            <button class="back-home-btn" onclick="showSection('home')">üè† Back Home</button>
        </div>
        <div id="dashboard-list"></div>
    </div>

    <div id="incoming" class="card section">
        <div class="nav-header">
            <h2>üì• Pending Verifications</h2>
            <button class="back-home-btn" onclick="showSection('home')">üè† Back Home</button>
        </div>
        <div id="incoming-list"></div>
    </div>

    <div id="detail" class="card section">
        <div class="nav-header">
            <h2 id="detail-title">Case View</h2>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-primary" style="width:auto; padding:10px 20px" onclick="triggerAI()">üß† Run AI Safety Check</button>
                <button class="back-home-btn" onclick="showSection('dashboard')">üîô Back</button>
            </div>
        </div>

        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('t-demo')">1. Demographics</button>
            <button class="tab-btn" onclick="switchTab('t-vitals')">2. Vitals</button>
            <button class="tab-btn" onclick="switchTab('t-labs')">3. Labs</button>
            <button class="tab-btn" onclick="switchTab('t-meds')">4. Meds</button>
            <button class="tab-btn" onclick="switchTab('t-allergies')">5. Allergies</button>
            <button class="tab-btn" onclick="switchTab('t-notes')">6. Notes</button>
            <button class="tab-btn" onclick="switchTab('t-risk')">7. Anchors</button>
            <button class="tab-btn" onclick="switchTab('t-plan')">8. Plan</button>
        </div>

        <div id="t-demo" class="tab-content active"><div class="form-grid"><div class="form-group"><label>Sex</label><select id="d-sex"><option>Male</option><option>Female</option></select></div><div class="form-group"><label>Admit Date</label><input type="date" id="d-date"></div></div></div>
        
        <div id="t-vitals" class="tab-content">
            <div class="form-grid">
                <div class="form-group"><label>SpO2 (%)</label><input type="number" id="v-spo2"></div>
                <div class="form-group"><label>HR (bpm)</label><input type="number" id="v-hr"></div>
                <div class="form-group"><label>BP</label><input type="text" id="v-bp"></div>
            </div>
        </div>

        <div id="t-labs" class="tab-content">
            <table id="lab-table"><tr><th>Test</th><th>Status</th><th>Action</th></tr></table>
            <button onclick="addRow('lab-table')" style="margin-top:10px">‚ûï Add Lab</button>
        </div>

        <div id="t-meds" class="tab-content">
            <table id="med-table"><tr><th>Medication</th><th>Status</th><th>Action</th></tr></table>
            <button onclick="addRow('med-table')" style="margin-top:10px">‚ûï Add Medication</button>
        </div>

        <div id="t-allergies" class="tab-content"><textarea id="d-allergies" rows="3" placeholder="List allergies..."></textarea></div>
        
        <div id="t-notes" class="tab-content"><textarea id="d-notes-inc" rows="5" placeholder="Incoming nurse assessment..."></textarea></div>

        <div id="t-risk" class="tab-content">
            <p style="margin-bottom:10px; font-weight:bold;">10 Clinical Safety Anchors:</p>
            <div class="checkbox-grid">
                <label class="check-box"><input type="checkbox" id="a-dnr"> DNR</label>
                <label class="check-box"><input type="checkbox" id="a-sepsis"> Sepsis</label>
                <label class="check-box"><input type="checkbox" id="a-vent"> Ventilator</label>
                <label class="check-box"><input type="checkbox" id="a-chf"> CHF</label>
                <label class="check-box"><input type="checkbox" id="a-fall"> Fall Risk</label>
                <label class="check-box"><input type="checkbox" id="a-iso"> Isolation</label>
                <label class="check-box"><input type="checkbox" id="a-post"> Post-Op</label>
                <label class="check-box"><input type="checkbox" id="a-renal"> Renal Failure</label>
                <label class="check-box"><input type="checkbox" id="a-diabetic"> Diabetic</label>
                <label class="check-box"><input type="checkbox" id="a-immuno"> Immunocompromised</label>
            </div>
        </div>

        <div id="t-plan" class="tab-content"><textarea id="d-plan" rows="5" placeholder="Document 24hr Care Plan..."></textarea></div>

        <div id="ai-output" style="display:none; margin-top:30px; padding:20px; border-radius:20px; background:#fff; border: 1px solid #ddd;">
            <div id="risk-circle" class="risk-circle"><span id="risk-text" style="font-size:1.8rem">LOW</span></div>
            <div id="risk-reasons" style="padding:10px;"></div>
        </div>
    </div>
</div>

<script>
    let cases = JSON.parse(localStorage.getItem('hosp_v4')) || [];
    let activeId = null;

    function showSection(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'dashboard') renderDashboard();
        if(id === 'incoming') renderIncoming();
        if(id === 'home') updateStats();
    }

    function switchTab(id) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(id).classList.add('active');
    }

    async function saveNewCase() {
        const name = document.getElementById('p-name').value;
        const notes = document.getElementById('p-notes').value;
        if(!name) return alert("Patient Name Required");

        // Simple PDF Mock Extraction Logic
        let pdfFound = [];
        const fileInput = document.getElementById('pdf-upload');
        if(fileInput.files.length > 0) {
            const fileName = fileInput.files[0].name.toLowerCase();
            // Simulating AI OCR scan on keywords
            const checkText = (name + " " + notes + " " + fileName).toLowerCase();
            if(checkText.includes('dnr')) pdfFound.push('DNR');
            if(checkText.includes('stop') || checkText.includes('discontinue')) pdfFound.push('STOP');
            if(checkText.includes('sepsis')) pdfFound.push('SEPSIS');
            if(checkText.includes('vent')) pdfFound.push('VENTILATOR');
        }

        const newCase = {
            id: Date.now(),
            name, notes, 
            age: document.getElementById('p-age').value,
            ward: document.getElementById('p-ward').value,
            vitals: { spo2: '', hr: '', bp: '' },
            anchors: [],
            pdfKeywords: pdfFound,
            plan: '', riskLevel: 'Not Analyzed', reasons: [], status: 'Pending'
        };

        cases.push(newCase);
        localStorage.setItem('hosp_v4', JSON.stringify(cases));
        alert("Case Created! AI scanned keywords: " + (pdfFound.join(', ') || 'None'));
        showSection('home');
    }

    function renderDashboard() {
        const list = document.getElementById('dashboard-list');
        list.innerHTML = cases.length ? '' : '<p>No records found.</p>';
        cases.forEach(c => {
            list.innerHTML += `<div class="card" style="display:flex; justify-content:space-between; align-items:center; border:1px solid #ddd">
                <div><strong>${c.name}</strong> - Ward: ${c.ward} <br><small>Risk: ${c.riskLevel}</small></div>
                <button class="back-home-btn" style="background:#3b82f6" onclick="openCase(${c.id})">Open Chart</button>
            </div>`;
        });
    }

    function renderIncoming() {
        const list = document.getElementById('incoming-list');
        const pending = cases.filter(c => c.status === 'Pending');
        list.innerHTML = pending.length ? '' : '<p>All verifications complete.</p>';
        pending.forEach(c => {
            list.innerHTML += `<div class="card" style="border-left: 10px solid #f59e0b">
                <h3>${c.name}</h3><p>Shift Notes: ${c.notes}</p>
                <button class="btn" onclick="openCase(${c.id})" style="margin-top:10px">Start Handoff Verification</button>
            </div>`;
        });
    }

    function openCase(id) {
        activeId = id;
        const c = cases.find(x => x.id === id);
        document.getElementById('detail-title').innerText = "Clinical Chart: " + c.name;
        document.getElementById('v-spo2').value = c.vitals.spo2;
        document.getElementById('d-plan').value = c.plan;
        
        // Load Anchors
        const anchorIds = ['dnr','sepsis','vent','chf','fall','iso','post','renal','diabetic','immuno'];
        anchorIds.forEach(a => document.getElementById('a-'+a).checked = c.anchors.includes(a));

        if(c.riskLevel !== 'Not Analyzed') showAIResult(c.riskLevel, c.reasons);
        else document.getElementById('ai-output').style.display = 'none';

        showSection('detail');
    }

    function triggerAI() {
        const c = cases.find(x => x.id === activeId);
        c.vitals.spo2 = document.getElementById('v-spo2').value;
        c.plan = document.getElementById('d-plan').value;
        c.anchors = ['dnr','sepsis','vent','chf','fall','iso','post','renal','diabetic','immuno'].filter(a => document.getElementById('a-'+a).checked);

        let reasons = [];
        let score = 0; // 0:Low, 1:Mod, 2:High

        // AI Logic 1: PDF "STOP" vs Medication
        if(c.pdfKeywords.includes('STOP')) {
            reasons.push("üö® PDF Scan alert: Document mentions 'STOP/DISCONTINUE'. Ensure meds list is updated.");
            score = 2;
        }

        // AI Logic 2: DNR Mismatch
        if(c.pdfKeywords.includes('DNR') && !c.anchors.includes('dnr')) {
            reasons.push("üö® Safety Gap: 'DNR' detected in PDF Chart but NOT flagged in active anchors.");
            score = 2;
        }

        // AI Logic 3: Clinical Critical (Hypoxia)
        if(c.vitals.spo2 && parseInt(c.vitals.spo2) < 92) {
            reasons.push("üö® High Risk: Patient SpO2 is below 92% (Critical Hypoxia).");
            score = 2;
        }

        // AI Logic 4: Sepsis Protocol
        if(c.anchors.includes('sepsis') && c.plan.length < 10) {
            reasons.push("‚ö†Ô∏è Care Gap: Sepsis flagged without a stabilization care plan.");
            if(score < 1) score = 1;
        }

        const level = score === 2 ? "High" : (score === 1 ? "Moderate" : "Low");
        c.riskLevel = level; c.reasons = reasons; c.status = "Analyzed";
        localStorage.setItem('hosp_v4', JSON.stringify(cases));
        showAIResult(level, reasons);
    }

    function showAIResult(level, reasons) {
        document.getElementById('ai-output').style.display = 'block';
        document.getElementById('risk-text').innerText = level.toUpperCase();
        document.getElementById('risk-circle').className = "risk-circle risk-" + level.toLowerCase();
        document.getElementById('risk-reasons').innerHTML = reasons.length ? reasons.map(r => `<p>‚Ä¢ ${r}</p>`).join('') : "‚úÖ Safe handoff detected.";
    }

    function updateStats() {
        document.getElementById('s-total').innerText = cases.length;
        document.getElementById('s-high').innerText = cases.filter(c => c.riskLevel === 'High').length;
    }

    function addRow(id) {
        const row = document.getElementById(id).insertRow();
        row.innerHTML = `<td><input type="text"></td><td><select><option>Active</option><option>Stopped</option></select></td><td><button onclick="this.parentElement.parentElement.remove()">üóëÔ∏è</button></td>`;
    }

    updateStats();
</script>
</body>

</html>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-analytics.js";
    import { 
        getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc 
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    // 2. Your Firebase Configuration (From your SDK image)
    const firebaseConfig = {
        apiKey: "AIzaSyDuyzmkUgxn3d1mZcIt3Ik6XSjz2pPcH20",
        authDomain: "brokenhandoffai.firebaseapp.com",
        projectId: "brokenhandoffai",
        storageBucket: "brokenhandoffai.firebasestorage.app",
        messagingSenderId: "877155578407",
        appId: "1:877155578407:web:ff3c4e64644ad611e15402",
        measurementId: "G-10CY4NSLHH"
    };

    // 3. Initialize Firebase & Firestore
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);
    const casesCol = collection(db, "handoffs");

    let cases = [];
    let activeId = null;

    // --- NAVIGATION LOGIC ---
    window.showSection = function(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'home') updateStats();
    }

    window.switchTab = function(id) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(id).classList.add('active');
    }

    // --- CLOUD DATA LOGIC ---

    // Listener: Automatically updates your dashboard when data changes in the cloud
    const q = query(casesCol, orderBy("timestamp", "desc"));
    onSnapshot(q, (snapshot) => {
        cases = [];
        snapshot.forEach((doc) => {
            cases.push({ id: doc.id, ...doc.data() });
        });
        renderDashboard();
        renderIncoming();
        updateStats();
    });

    // Save to Cloud (Replaces localStorage.setItem)
    window.saveNewCase = async function() {
        const name = document.getElementById('p-name').value;
        const notes = document.getElementById('p-notes').value;
        if(!name) return alert("Patient Name Required");

        let pdfFound = [];
        const fileInput = document.getElementById('pdf-upload');
        if(fileInput.files.length > 0) {
            const fileName = fileInput.files[0].name.toLowerCase();
            const checkText = (name + " " + notes + " " + fileName).toLowerCase();
            if(checkText.includes('dnr')) pdfFound.push('DNR');
            if(checkText.includes('stop') || checkText.includes('discontinue')) pdfFound.push('STOP');
            if(checkText.includes('sepsis')) pdfFound.push('SEPSIS');
            if(checkText.includes('vent')) pdfFound.push('VENTILATOR');
        }

        const newCase = {
            name, notes,
            timestamp: new Date(),
            age: document.getElementById('p-age').value,
            ward: document.getElementById('p-ward').value,
            vitals: { spo2: '', hr: '', bp: '' },
            anchors: [],
            pdfKeywords: pdfFound,
            plan: '', riskLevel: 'Not Analyzed', reasons: [], status: 'Pending'
        };

        try {
            await addDoc(casesCol, newCase);
            alert("Cloud Sync Successful: Case stored in Firestore!");
            showSection('home');
        } catch (e) {
            console.error("Error adding document: ", e);
        }
    }

    window.renderDashboard = function() {
        const list = document.getElementById('dashboard-list');
        if(!list) return;
        list.innerHTML = cases.length ? '' : '<p>No records found.</p>';
        cases.forEach(c => {
            list.innerHTML += `
                <div class="card" style="display:flex; justify-content:space-between; align-items:center; border:1px solid #ddd">
                    <div><strong>${c.name}</strong> - Ward: ${c.ward} <br><small>Risk: ${c.riskLevel}</small></div>
                    <button class="back-home-btn" style="background:#3b82f6" onclick="openCase('${c.id}')">Open Chart</button>
                </div>`;
        });
    }

    window.renderIncoming = function() {
        const list = document.getElementById('incoming-list');
        if(!list) return;
        const pending = cases.filter(c => c.status === 'Pending');
        list.innerHTML = pending.length ? '' : '<p>All verifications complete.</p>';
        pending.forEach(c => {
            list.innerHTML += `
                <div class="card" style="border-left: 10px solid #f59e0b">
                    <h3>${c.name}</h3><p>Shift Notes: ${c.notes}</p>
                    <button class="btn" onclick="openCase('${c.id}')" style="margin-top:10px">Start Handoff Verification</button>
                </div>`;
        });
    }

    window.openCase = function(id) {
        activeId = id;
        const c = cases.find(x => x.id === id);
        document.getElementById('detail-title').innerText = "Clinical Chart: " + c.name;
        document.getElementById('v-spo2').value = c.vitals.spo2;
        document.getElementById('d-plan').value = c.plan;
        
        const anchorIds = ['dnr','sepsis','vent','chf','fall','iso','post','renal','diabetic','immuno'];
        anchorIds.forEach(a => document.getElementById('a-'+a).checked = c.anchors.includes(a));

        if(c.riskLevel !== 'Not Analyzed') showAIResult(c.riskLevel, c.reasons);
        else document.getElementById('ai-output').style.display = 'none';

        showSection('detail');
    }

    window.triggerAI = async function() {
        const c = cases.find(x => x.id === activeId);
        const spo2 = document.getElementById('v-spo2').value;
        const plan = document.getElementById('d-plan').value;
        const anchors = ['dnr','sepsis','vent','chf','fall','iso','post','renal','diabetic','immuno'].filter(a => document.getElementById('a-'+a).checked);

        let reasons = [];
        let score = 0; 

        if(c.pdfKeywords.includes('STOP')) {
            reasons.push("üö® PDF Scan alert: Document mentions 'STOP/DISCONTINUE'. Ensure meds list is updated.");
            score = 2;
        }
        if(c.pdfKeywords.includes('DNR') && !anchors.includes('dnr')) {
            reasons.push("üö® Safety Gap: 'DNR' detected in PDF Chart but NOT flagged in active anchors.");
            score = 2;
        }
        if(spo2 && parseInt(spo2) < 92) {
            reasons.push("üö® High Risk: Patient SpO2 is below 92% (Critical Hypoxia).");
            score = 2;
        }
        if(anchors.includes('sepsis') && plan.length < 10) {
            reasons.push("‚ö†Ô∏è Care Gap: Sepsis flagged without a stabilization care plan.");
            if(score < 1) score = 1;
        }

        const level = score === 2 ? "High" : (score === 1 ? "Moderate" : "Low");
        
        // Update Cloud Document
        const docRef = doc(db, "handoffs", activeId);
        await updateDoc(docRef, {
            vitals: { spo2: spo2, hr: '', bp: '' },
            plan: plan,
            anchors: anchors,
            riskLevel: level,
            reasons: reasons,
            status: "Analyzed"
        });

        showAIResult(level, reasons);
    }

    function showAIResult(level, reasons) {
        document.getElementById('ai-output').style.display = 'block';
        document.getElementById('risk-text').innerText = level.toUpperCase();
        document.getElementById('risk-circle').className = "risk-circle risk-" + level.toLowerCase();
        document.getElementById('risk-reasons').innerHTML = reasons.length ? reasons.map(r => `<p>‚Ä¢ ${r}</p>`).join('') : "‚úÖ Safe handoff detected.";
    }

    window.updateStats = function() {
        document.getElementById('s-total').innerText = cases.length;
        document.getElementById('s-high').innerText = cases.filter(c => c.riskLevel === 'High').length;
    }

    window.addRow = function(id) {
        const row = document.getElementById(id).insertRow();
        row.innerHTML = `<td><input type="text"></td><td><select><option>Active</option><option>Stopped</option></select></td><td><button onclick="this.parentElement.parentElement.remove()">üóëÔ∏è</button></td>`;
    }

    updateStats();
</script>

