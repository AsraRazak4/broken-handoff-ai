<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè• Broken Handoff AI - Clinical Safety Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #10b981 100%);
            min-height: 100vh; padding: 20px; color: #1f2937;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 40px; animation: glow 2s ease-in-out infinite alternate; }
        @keyframes glow { from { text-shadow: 0 0 20px #60a5fa; } to { text-shadow: 0 0 30px #34d399; } }
        
        .card { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); border-radius: 24px; padding: 35px; margin-bottom: 25px; box-shadow: 0 25px 50px rgba(0,0,0,0.15); border: 1px solid rgba(255,255,255,0.2); transition: all 0.3s ease; }
        
        .nav-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .back-home-btn { background: #1e293b; color: white; border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: 0.3s; }
        .back-home-btn:hover { background: #334155; transform: scale(1.05); }

        .btn { background: linear-gradient(45deg, #10b981, #34d399); color: white; border: none; padding: 16px 32px; border-radius: 16px; font-size: 1.1rem; font-weight: 700; cursor: pointer; width: 100%; margin-bottom: 20px; transition: all 0.3s; box-shadow: 0 10px 30px rgba(16,185,129,0.3); }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 20px 40px rgba(16,185,129,0.4); }
        .btn-primary { background: linear-gradient(45deg, #3b82f6, #60a5fa); }
        .btn-secondary { background: #64748b; }

        .section { display: none; animation: slideIn 0.5s ease-out; }
        .section.active { display: block; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 700; margin-bottom: 8px; color: #1e293b; }
        input, textarea, select { width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; }

        .tab-nav { display: flex; flex-wrap: wrap; gap: 5px; background: #f1f5f9; padding: 5px; border-radius: 16px; margin-bottom: 20px; }
        .tab-btn { flex: 1; min-width: 120px; padding: 12px; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; transition: 0.3s; }
        .tab-btn.active { background: #3b82f6; color: white; }

        .tab-content { display: none; padding: 20px; border: 1px solid #e2e8f0; border-radius: 16px; background: white; }
        .tab-content.active { display: block; }

        .risk-circle { width: 180px; height: 180px; border-radius: 50%; margin: 0 auto 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 800; border: 8px solid #eee; }
        .risk-high { background: #fee2e2; color: #dc2626; border-color: #dc2626; }
        .risk-moderate { background: #fef3c7; color: #d97706; border-color: #d97706; }
        .risk-low { background: #dcfce7; color: #16a34a; border-color: #16a34a; }

        .checkbox-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
        .check-box { background: #fff; border: 2px solid #e2e8f0; padding: 15px; border-radius: 12px; display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 12px; background: #f8fafc; border-bottom: 2px solid #e2e8f0; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; }

        .pdf-scanner { background: #fef3c7; border: 2px dashed #f59e0b; padding: 15px; border-radius: 16px; margin-bottom: 20px; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üè• Broken Handoff AI</h1>
        <p>Production-Grade Clinical Dashboard</p>
    </div>

    <div id="home" class="card section active">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
            <div style="background:white; padding:20px; border-radius:16px; text-align:center;">
                <h2 id="s-high" style="color:#ef4444">0</h2><p>High Risk</p>
            </div>
            <div style="background:white; padding:20px; border-radius:16px; text-align:center;">
                <h2 id="s-total">0</h2><p>Total Cases</p>
            </div>
        </div>
        <button class="btn" onclick="showSection('outgoing')">üì§ Create Outgoing Case</button>
        <button class="btn btn-primary" onclick="showSection('dashboard')">üìã Hospital Dashboard</button>
        <button class="btn btn-secondary" onclick="showSection('incoming')">üì• Incoming Nurse Verification</button>
    </div>

    <div id="outgoing" class="card section">
        <div class="nav-header">
            <h2>üì§ New Handoff Entry</h2>
            <button class="back-home-btn" onclick="showSection('home')">üè† Back Home</button>
        </div>
        <div class="form-grid">
            <div class="form-group"><label>Patient Name</label><input type="text" id="p-name"></div>
            <div class="form-group"><label>Age</label><input type="number" id="p-age"></div>
            <div class="form-group"><label>Ward Location</label><input type="text" id="p-ward"></div>
        </div>
        <div class="pdf-scanner">
            <label>üìÑ Upload Clinical Chart / PDF (Optional AI Scan)</label>
            <input type="file" id="pdf-upload" accept=".pdf,.txt" style="margin-top:10px;">
            <p style="font-size: 0.8rem; margin-top: 5px;">AI scans for: DNR, Sepsis, Insulin, Suicide, NPO, etc.</p>
        </div>
        <div class="form-group">
            <label>Handoff Notes (Outgoing Nurse)</label>
            <textarea id="p-notes" rows="4" placeholder="Mention critical updates..."></textarea>
        </div>
        <button class="btn" onclick="saveNewCase()">üíæ Initialize Case</button>
    </div>

    <div id="dashboard" class="card section">
        <div class="nav-header"><h2>üìã Patient Records</h2><button class="back-home-btn" onclick="showSection('home')">üè† Home</button></div>
        <div id="dashboard-list"></div>
    </div>
    <div id="incoming" class="card section">
        <div class="nav-header"><h2>üì• Pending Verifications</h2><button class="back-home-btn" onclick="showSection('home')">üè† Home</button></div>
        <div id="incoming-list"></div>
    </div>

    <div id="detail" class="card section">
        <div class="nav-header">
            <h2 id="detail-title">Case View</h2>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-primary" style="width:auto; padding:10px 20px" onclick="triggerAI()">üß† Run AI Safety Check</button>
                <button class="back-home-btn" onclick="showSection('dashboard')">üîô Back</button>
            </div>
        </div>

        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('t-demo')">1. Demographics</button>
            <button class="tab-btn" onclick="switchTab('t-vitals')">2. Vitals</button>
            <button class="tab-btn" onclick="switchTab('t-labs')">3. Labs</button>
            <button class="tab-btn" onclick="switchTab('t-meds')">4. Meds</button>
            <button class="tab-btn" onclick="switchTab('t-allergies')">5. Allergies</button>
            <button class="tab-btn" onclick="switchTab('t-notes')">6. Notes</button>
            <button class="tab-btn" onclick="switchTab('t-risk')">7. Anchors</button>
            <button class="tab-btn" onclick="switchTab('t-plan')">8. Plan</button>
        </div>

        <div id="t-demo" class="tab-content active"><div class="form-grid"><div class="form-group"><label>Sex</label><select id="d-sex"><option>Male</option><option>Female</option></select></div><div class="form-group"><label>Admit Date</label><input type="date" id="d-date"></div></div></div>
        <div id="t-vitals" class="tab-content"><div class="form-grid"><div class="form-group"><label>SpO2 (%)</label><input type="number" id="v-spo2"></div><div class="form-group"><label>HR (bpm)</label><input type="number" id="v-hr"></div><div class="form-group"><label>BP</label><input type="text" id="v-bp"></div></div></div>
        <div id="t-labs" class="tab-content"><table id="lab-table"><tr><th>Test</th><th>Status</th><th>Action</th></tr></table><button onclick="addRow('lab-table')">‚ûï Add Lab</button></div>
        <div id="t-meds" class="tab-content"><table id="med-table"><tr><th>Medication</th><th>Status</th><th>Action</th></tr></table><button onclick="addRow('med-table')">‚ûï Add Med</button></div>
        
        <div id="t-allergies" class="tab-content"><label>Allergy Profile</label><textarea id="d-allergies" rows="3" placeholder="List confirmed allergies..."></textarea></div>
        <div id="t-notes" class="tab-content"><label>Original Handoff History</label><div id="d-notes-display" style="padding:15px; background:#f8fafc; border-radius:12px; border:1px solid #e2e8f0; min-height:100px;"></div></div>

        <div id="t-risk" class="tab-content">
            <p style="margin-bottom:10px; font-weight:bold; color: #1e3a8a;">üõ°Ô∏è 20-Point Clinical Safety Verification</p>
            <input type="text" id="anchor-search" placeholder="üîç Search anchors..." style="border: 2px solid #3b82f6; padding: 10px; margin-bottom:15px;" onkeyup="filterAnchors()">
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <p style="font-size: 0.8rem; color: #ef4444; font-weight: bold;">CRITICAL ALERTS</p>
                    <div class="checkbox-grid" style="grid-template-columns: 1fr;">
                        <label class="check-box"><input type="checkbox" id="a-dnr"> DNR / DNI</label>
                        <label class="check-box"><input type="checkbox" id="a-sepsis"> Sepsis Protocol</label>
                        <label class="check-box"><input type="checkbox" id="a-fall"> High Fall Risk</label>
                        <label class="check-box"><input type="checkbox" id="a-allergy"> Severe Allergy</label>
                        <label class="check-box"><input type="checkbox" id="a-suicide"> Self-Harm Risk</label>
                    </div>
                </div>
                <div>
                    <p style="font-size: 0.8rem; color: #3b82f6; font-weight: bold;">RESPIRATORY / CARDIAC</p>
                    <div class="checkbox-grid" style="grid-template-columns: 1fr;">
                        <label class="check-box"><input type="checkbox" id="a-vent"> Ventilator / CPAP</label>
                        <label class="check-box"><input type="checkbox" id="a-chf"> CHF / Edema</label>
                        <label class="check-box"><input type="checkbox" id="a-copd"> COPD / Asthma</label>
                        <label class="check-box"><input type="checkbox" id="a-afib"> AFib / Arrhythmia</label>
                        <label class="check-box"><input type="checkbox" id="a-chest"> Chest Pain (ACS)</label>
                    </div>
                </div>
                <div>
                    <p style="font-size: 0.8rem; color: #10b981; font-weight: bold;">METABOLIC / RENAL</p>
                    <div class="checkbox-grid" style="grid-template-columns: 1fr;">
                        <label class="check-box"><input type="checkbox" id="a-diabetic"> Diabetic (Insulin)</label>
                        <label class="check-box"><input type="checkbox" id="a-renal"> Renal Failure / Dialysis</label>
                        <label class="check-box"><input type="checkbox" id="a-liver"> Hepatic Impairment</label>
                        <label class="check-box"><input type="checkbox" id="a-npo"> NPO Status</label>
                    </div>
                </div>
                <div>
                    <p style="font-size: 0.8rem; color: #f59e0b; font-weight: bold;">INFECTION</p>
                    <div class="checkbox-grid" style="grid-template-columns: 1fr;">
                        <label class="check-box"><input type="checkbox" id="a-iso"> Isolation Precautions</label>
                        <label class="check-box"><input type="checkbox" id="a-immuno"> Immunocompromised</label>
                        <label class="check-box"><input type="checkbox" id="a-post"> Post-Op (< 24hr)</label>
                        <label class="check-box"><input type="checkbox" id="a-mrsa"> MRSA / MDRO</label>
                    </div>
                </div>
            </div>
        </div>

        <div id="t-plan" class="tab-content"><textarea id="d-plan" rows="5" placeholder="Document 24hr Care Plan..."></textarea></div>

        <div id="ai-output" style="display:none; margin-top:30px; padding:20px; border-radius:20px; background:#fff; border: 1px solid #ddd; text-align:center;">
            <div id="risk-circle" class="risk-circle"><span id="risk-text" style="font-size:1.8rem">LOW</span></div>
            <div id="risk-reasons" style="text-align:left; padding:10px; max-width:600px; margin: 0 auto;"></div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    // CORE CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyDuyzmkUgxn3d1mZcIt3Ik6XSjz2pPcH20",
        authDomain: "brokenhandoffai.firebaseapp.com",
        projectId: "brokenhandoffai",
        storageBucket: "brokenhandoffai.firebasestorage.app",
        messagingSenderId: "877155578407",
        appId: "1:877155578407:web:ff3c4e64644ad611e15402"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const casesCol = collection(db, "handoffs");

    let allCases = [];
    let activeId = null;
    const anchorIds = ['dnr','sepsis','vent','chf','fall','iso','post','renal','diabetic','immuno','allergy','suicide','copd','afib','chest','liver','npo','mrsa'];

    // UI Logic
    window.showSection = (id) => {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    };

    window.switchTab = (id) => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(id).classList.add('active');
    };

    // Firebase Sync
    const q = query(casesCol, orderBy("timestamp", "desc"));
    onSnapshot(q, (snapshot) => {
        allCases = [];
        snapshot.forEach((doc) => allCases.push({ id: doc.id, ...doc.data() }));
        updateStats();
        renderDashboard();
        renderIncoming();
    });

    window.saveNewCase = async function() {
    const name = document.getElementById('p-name').value;
    const notes = document.getElementById('p-notes').value;
    const fileInput = document.getElementById('pdf-upload');
    
    if(!name) return alert("‚ö†Ô∏è Patient Name Required");

    let fileContent = "";
    
    // 1. Read the file if one is uploaded
    if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        // For the demo, we read it as text. 
        // In a full prod app, we'd use pdf.js for binary PDFs.
        fileContent = await file.text(); 
    }

    // 2. Comprehensive AI Keyword Scan
    let pdfFound = [];
    const checkText = (name + " " + notes + " " + fileContent).toLowerCase();
    
    // Expanded clinical dictionary for the "Wow" factor
    const keywords = {
        'dnr': 'DNR (Do Not Resuscitate)',
        'sepsis': 'SEPSIS PROTOCOL',
        'infection': 'SEPSIS PROTOCOL',
        'vent': 'VENTILATOR SUPPORT',
        'sugar': 'DIABETIC CARE',
        'insulin': 'DIABETIC CARE',
        'fall': 'FALL PRECAUTIONS',
        'npo': 'NPO (Nothing by Mouth)',
        'suicide': 'SELF-HARM RISK'
    };
    
    Object.keys(keywords).forEach(k => { 
        if(checkText.includes(k)) {
            if(!pdfFound.includes(keywords[k])) pdfFound.push(keywords[k]);
        }
    });

    // 3. THE ALERT YOU WANTED
    if (pdfFound.length > 0) {
        alert(`‚úÖ Case Created Successfully!\n\nüß† AI SCAN COMPLETED:\nThe following safety markers were detected and linked to this case:\n‚Ä¢ ${pdfFound.join('\n‚Ä¢ ')}`);
    } else {
        alert("‚úÖ Case Created Successfully! (No critical AI markers detected)");
    }

    // 4. Save to Firebase
    await addDoc(casesCol, {
        name, 
        notes, 
        age: document.getElementById('p-age').value, 
        ward: document.getElementById('p-ward').value,
        timestamp: new Date(), 
        status: 'Pending', 
        vitals: { spo2: '' }, 
        anchors: [], 
        pdfKeywords: pdfFound, // Stores the keywords found by AI
        riskLevel: 'Not Analyzed', 
        reasons: []
    });

    showSection('home');
};

    window.openCase = (id) => {
        activeId = id;
        const c = allCases.find(x => x.id === id);
        document.getElementById('detail-title').innerText = "Clinical Chart: " + c.name;
        document.getElementById('d-notes-display').innerText = c.notes;
        document.getElementById('v-spo2').value = c.vitals?.spo2 || '';
        anchorIds.forEach(a => document.getElementById('a-'+a).checked = (c.anchors || []).includes(a));
        
        if(c.riskLevel !== 'Not Analyzed') showAIResult(c.riskLevel, c.reasons);
        else document.getElementById('ai-output').style.display = 'none';
        showSection('detail');
    };

    // BROADER AI SCANNING LOGIC
    window.triggerAI = async function() {
        const c = allCases.find(x => x.id === activeId);
        const spo2 = document.getElementById('v-spo2').value;
        const selectedAnchors = anchorIds.filter(a => document.getElementById('a-'+a).checked);
        let reasons = [];
        let score = 0; 
        const notesLower = (c.notes + " " + (c.pdfKeywords.join(" "))).toLowerCase();

        // Safety Net Groups
        const safetyNet = [
            { id: 'sepsis', keys: ['sepsis','infection','fever','lactate','tachycardia','wbc'], label: 'Sepsis Protocol' },
            { id: 'diabetic', keys: ['diabetes','insulin','glucose','sugar','metformin'], label: 'Diabetic/Glucose Monitoring' },
            { id: 'fall', keys: ['fall','unsteady','dizzy','confusion','weakness'], label: 'Fall Precautions' },
            { id: 'vent', keys: ['vent','intubated','cpap','bipap','respirator'], label: 'Respiratory/Ventilator Support' },
            { id: 'renal', keys: ['renal','kidney','dialysis','creatinine','bun'], label: 'Renal/Kidney Care' },
            { id: 'allergy', keys: ['allergy','anaphylaxis','reaction','hives'], label: 'Severe Allergy' }
        ];

        safetyNet.forEach(group => {
            const match = group.keys.some(k => notesLower.includes(k));
            if(match && !selectedAnchors.includes(group.id)) {
                reasons.push(`üö® Clinical Oversight: Evidence of **${group.label}** detected in history, but anchor was not verified.`);
                score = 2;
            }
        });

        if(spo2 && parseInt(spo2) < 92) { reasons.push("üö® High Risk: SpO2 < 92% detected without verified respiratory plan."); score = 2; }

        const level = score === 2 ? "High" : "Low";
        await updateDoc(doc(db, "handoffs", activeId), {
            riskLevel: level, reasons: reasons, status: 'Analyzed', 
            vitals: { spo2: spo2 }, anchors: selectedAnchors
        });
        showAIResult(level, reasons);
    };

    function showAIResult(level, reasons) {
        document.getElementById('ai-output').style.display = 'block';
        document.getElementById('risk-text').innerText = level.toUpperCase();
        document.getElementById('risk-circle').className = "risk-circle risk-" + level.toLowerCase();
        document.getElementById('risk-reasons').innerHTML = reasons.length ? 
            "<h3>AI Safety Summary:</h3>" + reasons.map(r => `<p style="margin-top:8px;">‚Ä¢ ${r}</p>`).join('') : 
            "‚úÖ Safe Handoff: Incoming nurse verification matches clinical history.";
    }

    // Helper functions
    function renderDashboard() {
        const list = document.getElementById('dashboard-list');
        if(!list) return;
        list.innerHTML = '';
        allCases.forEach(c => {
            list.innerHTML += `<div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                <div><strong>${c.name}</strong> - Ward: ${c.ward}<br><small>AI Status: ${c.riskLevel}</small></div>
                <button class="back-home-btn" style="background:#3b82f6" onclick="openCase('${c.id}')">View Chart</button>
            </div>`;
        });
    }

    function renderIncoming() {
        const list = document.getElementById('incoming-list');
        const pending = allCases.filter(c => c.status === 'Pending');
        if(!list) return;
        list.innerHTML = pending.length ? '' : '<p>All verifications complete.</p>';
        pending.forEach(c => {
            list.innerHTML += `<div class="card" style="border-left: 10px solid #f59e0b">
                <h3>${c.name}</h3><p style="margin:10px 0;">${c.notes}</p>
                <button class="btn" onclick="openCase('${c.id}')">Start Verification</button>
            </div>`;
        });
    }

    function updateStats() {
        document.getElementById('s-total').innerText = allCases.length;
        document.getElementById('s-high').innerText = allCases.filter(c => c.riskLevel === 'High').length;
    }

    window.filterAnchors = () => {
        const input = document.getElementById('anchor-search').value.toLowerCase();
        document.querySelectorAll('.check-box').forEach(cb => {
            cb.style.display = cb.innerText.toLowerCase().includes(input) ? "flex" : "none";
        });
    };

    window.addRow = (id) => {
        const row = document.getElementById(id).insertRow();
        row.innerHTML = `<td><input type="text"></td><td><select><option>Active</option><option>Stopped</option></select></td><td><button onclick="this.parentElement.parentElement.remove()">üóëÔ∏è</button></td>`;
    };
</script>
</body>
</html>

